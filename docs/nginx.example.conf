# NGINX example config for pipeline-dashboard (no authorization, same-origin)
# - Serves the SPA at http://<host>:8080/pipeline-dashboard
# - Proxies the API at http://<host>:8080/pipeline-service/ to upstream http://usaz15ls088:8001/
# - No Authorization header required; no CORS headers emitted (same-origin in prod)
# - Long cache for versioned assets; no-cache for index.html

worker_processes auto;

events {
  worker_connections 4096;
  multi_accept on;
}

http {
  include       mime.types;
  default_type  application/octet-stream;

  access_log  /export/home/dpower/nginx/logs/access.log;
  error_log   /export/home/dpower/nginx/logs/error.log warn;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;

  keepalive_timeout 65;
  keepalive_requests 1000;

  server_tokens off;

  gzip on;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_vary on;
  gzip_proxied any;
  gzip_types
    text/plain text/css text/javascript application/javascript application/x-javascript
    application/json application/xml application/xml+rss image/svg+xml;

  upstream jnd-lot-metadata {
    server usaz15ls088:8000;
    keepalive 64;
  }

  upstream pipeline-service {
    server usaz15ls088:8001;
    keepalive 64;
  }

  server {
    listen 8080;
    server_name localhost;

    # Generic web root (error pages etc.)
    root /export/home/dpower/nginx/html;

    # Static SPA assets
    location ^~ /pipeline-dashboard/assets/ {
      alias /export/home/dpower/nginx/html/pipeline-dashboard/assets/;
      access_log off;
      expires 1y;
      add_header Cache-Control "public, immutable";
    }

    # SPA entry + routes
    location ^~ /pipeline-dashboard/ {
      alias /export/home/dpower/nginx/html/pipeline-dashboard/;
      index index.html;
      try_files $uri $uri/ /pipeline-dashboard/index.html;
    }

    # Ensure SPA index is not cached
    location = /pipeline-dashboard/index.html {
      alias /export/home/dpower/nginx/html/pipeline-dashboard/index.html;
      expires -1;
      add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
      add_header Pragma "no-cache" always;
    }

    # API: /jnd-lot-metadata -> http://usaz15ls088:8000/
    location /jnd-lot-metadata/ {
      proxy_pass http://jnd-lot-metadata/;   # note trailing slash
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Prefix /jnd-lot-metadata;
      proxy_connect_timeout 5s;
      proxy_send_timeout 30s;
      proxy_read_timeout 30s;
    }

    # API: /pipeline-service -> http://usaz15ls088:8001/
    location /pipeline-service/ {
      proxy_pass http://pipeline-service/;   # note trailing slash
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Prefix /pipeline-service;

      # No CORS headers here (same-origin). If cross-origin needed, see docs/NGINX_CORS.md

      proxy_connect_timeout 5s;
      proxy_send_timeout 30s;
      proxy_read_timeout 30s;
    }

    # Redirect absolute docs/OpenAPI asset URLs to the prefixed path
    location = /docs { return 301 /pipeline-service/docs; }
    location ^~ /docs/ { return 301 /pipeline-service$uri$is_args$args; }
    location = /openapi.json { return 301 /pipeline-service/openapi.json; }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html { root /export/home/dpower/nginx/html; }
  }
}
